name: Build JamesDSPManager-RE APK

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Main/DSPManager/**'
      - 'Main/libjamesdsp/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e
        add-to-path: true
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install SDK Platform & Build Tools
      run: |
        sdkmanager "platforms;android-29"
        sdkmanager "build-tools;29.0.3"
        
    - name: Grant Execute Permission for Gradlew (if exists)
      run: |
        if [ -f "Main/DSPManager/gradlew" ]; then
          chmod +x Main/DSPManager/gradlew
        fi
        
    - name: Build Native Libraries
      run: |
        cd Main/DSPManager
        ndk-build clean
        ndk-build -j$(nproc)
        
    - name: Create local.properties
      run: |
        cd Main/DSPManager
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_NDK_HOME" >> local.properties
        
    - name: Build Debug APK with Ant
      run: |
        cd Main/DSPManager
        # Update project (creates build.xml if missing)
        android update project --path . --target android-29 --name JamesDSPManagerRE
        # Build with Ant
        ant clean
        ant debug
        
    - name: Sign APK (Optional)
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |
        cd Main/DSPManager
        # This is a placeholder - you'd need to add signing keys as secrets
        echo "APK built successfully"
        
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-debug
        path: Main/DSPManager/bin/*-debug.apk
        if-no-files-found: error
        
    - name: Get APK Info
      run: |
        cd Main/DSPManager/bin
        ls -lh *-debug.apk
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: Main/DSPManager/bin/*-debug.apk
        body: |
          ## JamesDSPManager-RE Release
          
          **Version:** ${{ github.ref_name }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          
          ### Changes
          ${{ github.event.head_commit.message }}
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
