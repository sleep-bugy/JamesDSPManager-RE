name: Build JamesDSPManager-RE Magisk Module

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Main/DSPManager/**'
      - 'Main/libjamesdsp/**'
      - 'magisk_module/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e
        add-to-path: true
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install SDK Platform & Build Tools
      run: |
        sdkmanager "platforms;android-29"
        sdkmanager "build-tools;29.0.3"
        
    - name: Build Native Libraries
      run: |
        cd Main/DSPManager
        ndk-build clean
        ndk-build -j$(nproc)
        
    - name: Create local.properties
      run: |
        cd Main/DSPManager
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_NDK_HOME" >> local.properties
        
    - name: Create build configuration
      run: |
        cd Main/DSPManager
        
        # Create build.xml manually since 'android' tool is deprecated
        cat > build.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <project name="JamesDSPManagerRE" default="help">
            <property file="local.properties" />
            <property file="ant.properties" />
            <property environment="env" />
            <condition property="sdk.dir" value="${env.ANDROID_HOME}">
                <isset property="env.ANDROID_HOME" />
            </condition>
            <loadproperties srcFile="project.properties" />
            <fail
                message="sdk.dir is missing. Make sure to generate local.properties using 'android update project' or to inject it through the ANDROID_HOME environment variable."
                unless="sdk.dir"
            />
            <import file="custom_rules.xml" optional="true" />
            <import file="${sdk.dir}/tools/ant/build.xml" />
        </project>
        EOF
        
    - name: Build APK with Ant
      run: |
        cd Main/DSPManager
        ant clean
        ant debug
        
    - name: Prepare Magisk Module Structure
      run: |
        mkdir -p magisk_release/system/priv-app/JamesDSPManagerRE
        mkdir -p magisk_release/system/lib/soundfx
        mkdir -p magisk_release/system/lib64/soundfx
        
        # Copy APK
        cp Main/DSPManager/bin/*-debug.apk magisk_release/system/priv-app/JamesDSPManagerRE/JamesDSPManagerRE.apk
        
        # Copy native libraries
        cp Main/DSPManager/libs/armeabi-v7a/libjamesdsp.so magisk_release/system/lib/soundfx/ 2>/dev/null || true
        cp Main/DSPManager/libs/arm64-v8a/libjamesdsp.so magisk_release/system/lib64/soundfx/ 2>/dev/null || true
        
        # Copy module files
        cp -r magisk_module/* magisk_release/
        
        # Set permissions
        chmod 755 magisk_release/customize.sh
        chmod 755 magisk_release/service.sh
        chmod 755 magisk_release/META-INF/com/google/android/update-binary
        
    - name: Create Magisk Module ZIP
      run: |
        cd magisk_release
        zip -r9 ../JamesDSPManager-RE-v10.0-RE.zip * -x '*.git*'
        cd ..
        ls -lh JamesDSPManager-RE-v10.0-RE.zip
        
    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Magisk-Module
        path: JamesDSPManager-RE-v10.0-RE.zip
        
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: JamesDSPManager-RE-v10.0-RE.zip
        body: |
          ## JamesDSPManager-RE Magisk Module
          
          **Version:** ${{ github.ref_name }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Maintainer:** Mohammad Adi
          
          ### Installation
          1. Download the ZIP file
          2. Flash via Magisk Manager
          3. Reboot
          4. Open JamesDSP Manager RE from launcher
          
          ### Requirements
          - Android 5.0+ (API 21+)
          - Magisk 20.4+
          - ARM/ARM64 architecture
          
          ### Changes
          ${{ github.event.head_commit.message }}
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
