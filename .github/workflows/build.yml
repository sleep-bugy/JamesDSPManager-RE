name: Build JamesDSPManager-RE Magisk Module

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Main/**'
      - 'magisk_module/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e
        add-to-path: true
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: '7.5'
        
    - name: Grant Execute Permission for Gradlew
      run: |
        cd Main
        chmod +x gradlew || echo "gradlew not found, will use gradle wrapper"
        
    - name: Build Debug APK with Gradle
      run: |
        cd Main
        ./gradlew assembleDebug --stacktrace
        
    - name: Prepare Magisk Module Structure
      run: |
        # Create module structure matching original JamesDSP format
        mkdir -p magisk_release/common/files/arm
        mkdir -p magisk_release/common/files/x86  
        mkdir -p magisk_release/common/files/JamesDSP/Convolver
        mkdir -p magisk_release/common/files/JamesDSP/DDC
        mkdir -p magisk_release/common/files/JamesDSP/liveprog
        mkdir -p magisk_release/common/files/JamesDSP/Presets
        
        # Copy APK
        cp Main/DSPManager/build/outputs/apk/debug/*.apk magisk_release/common/files/JamesDSPManager.apk
        
        # Copy native libraries to proper arch folders
        find Main/DSPManager/build/intermediates/ndkBuild -name "libjamesdsp.so" -path "*/armeabi-v7a/*" -exec cp {} magisk_release/common/files/arm/ \; 2>/dev/null || true
        find Main/DSPManager/build/intermediates/ndkBuild -name "libjamesdsp.so" -path "*/x86/*" -exec cp {} magisk_release/common/files/x86/ \; 2>/dev/null || true
        
        # Copy module metadata and scripts
        cp -r magisk_module/* magisk_release/
        
        # Set executable permissions
        chmod 755 magisk_release/customize.sh
        chmod 755 magisk_release/service.sh
        chmod 755 magisk_release/META-INF/com/google/android/update-binary
        
    - name: Create Magisk Module ZIP
      run: |
        cd magisk_release
        zip -r9 ../JamesDSPManager-RE-v10.0-RE.zip * -x '*.git*'
        cd ..
        ls -lh JamesDSPManager-RE-v10.0-RE.zip
        
    - name: Upload Magisk Module
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Magisk-Module
        path: JamesDSPManager-RE-v10.0-RE.zip
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: JamesDSPManager-RE-Debug-APK
        path: Main/DSPManager/build/outputs/apk/debug/*.apk
        
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          JamesDSPManager-RE-v10.0-RE.zip
          Main/DSPManager/build/outputs/apk/debug/*.apk
        body: |
          ## JamesDSPManager-RE Release
          
          **Version:** ${{ github.ref_name }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Maintainer:** Mohammad Adi
          
          ### Installation
          
          **Magisk Module (Recommended):**
          1. Download `JamesDSPManager-RE-v10.0-RE.zip`
          2. Flash via Magisk Manager
          3. Reboot
          
          **Standalone APK:**
          1. Download the APK file
          2. Install manually
          3. May require manual audio effects configuration
          
          ### Requirements
          - Android 5.0+ (API 21+)
          - Magisk 20.4+ (for module installation)
          - ARM/ARM64 architecture
          
          ### Changes
          ${{ github.event.head_commit.message }}
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
